{
  "builders": [
    {
      "communicator": "ssh",
      "provider": "virtualbox",
      "skip_package": true,
      "source_path": "alvistack/ubuntu-20.04",
      "teardown_method": "halt",
      "template": "./Vagrantfile.template",
      "type": "vagrant"
    }
  ],
  "post-processors": [
    {
      "inline": [
        "set -eu",
        "export _IMAGE=\"$(sudo bash -c \"ls -1d /home/vagrant/VirtualBox*/output-vagrant_source*/*.vmdk\")\"",
        "export _UUID=\"$(sudo vboxmanage showhdinfo \"$_IMAGE\" | egrep -e \"^UUID:\" | sed \"s/^UUID:\\s*//g\")\"",
        "sudo qemu-img convert -f vmdk -O qcow2 \"$_IMAGE\" \"$_IMAGE.convert\"",
        "sudo rm -rf \"$_IMAGE\"",
        "sudo chmod a+r /boot/vmlinuz*",
        "sudo virt-sysprep --operations defaults,-ssh-userdir,-customize -a \"$_IMAGE.convert\"",
        "sudo virt-sparsify --in-place \"$_IMAGE.convert\"",
        "sudo qemu-img convert -f qcow2 -O vmdk \"$_IMAGE.convert\" \"$_IMAGE\"",
        "sudo vboxmanage internalcommands sethduuid \"$_IMAGE\" \"$_UUID\"",
        "sudo rm -rf \"$_IMAGE.convert\"",
        "cd output-vagrant",
        "vagrant package source",
        "vagrant destroy --force source"
      ],
      "type": "shell-local"
    }
  ],
  "provisioners": [
    {
      "galaxy_file": "./ansible-galaxy-requirements.yml",
      "inventory_directory": "./",
      "playbook_file": "./packer.yml",
      "type": "ansible",
      "user": "vagrant"
    }
  ]
}

