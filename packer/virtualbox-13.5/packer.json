{
  "builders": [
    {
      "communicator": "ssh",
      "provider": "virtualbox",
      "skip_package": true,
      "source_path": "generic/ubuntu2004",
      "teardown_method": "halt",
      "template": "./Vagrantfile.template",
      "type": "vagrant"
    }
  ],
  "post-processors": [
    {
      "inline": [
        "set -eu",
        "export _SOURCE=\"$(sudo bash -c \"ls -1d /home/vagrant/VirtualBox*/output-vagrant_source*/*.vmdk\")\"",
        "export _TARGET=\"$(echo \"$_SOURCE\" | sed \"s/.vmdk$/.qcow2/g\")\"",
        "export _UUID=\"$(sudo vboxmanage showhdinfo \"$_SOURCE\" | egrep -e \"^UUID:\" | sed \"s/^UUID:\\s*//g\")\"",
        "sudo qemu-img convert -f vmdk -O qcow2 \"$_SOURCE\" \"$_TARGET\"",
        "sudo rm -rf \"$_SOURCE\"",
        "sudo virt-sysprep --operations defaults,-ssh-userdir,-customize -a \"$_TARGET\"",
        "sudo virt-sparsify --in-place \"$_TARGET\"",
        "sudo qemu-img convert -f qcow2 -O vmdk \"$_TARGET\" \"$_SOURCE\"",
        "sudo vboxmanage internalcommands sethduuid \"$_SOURCE\" \"$_UUID\"",
        "sudo rm -rf \"$_TARGET\"",
        "cd output-vagrant",
        "vagrant package source",
        "vagrant destroy --force source"
      ],
      "type": "shell-local"
    }
  ],
  "provisioners": [
    {
      "inline": [
        "set -eu",
        "sudo apt-get update",
        "sudo apt-get dist-upgrade -y",
        "sudo apt-get install -y ca-certificates curl gcc iproute2 python3 python3-dev sudo"
      ],
      "type": "shell"
    },
    {
      "galaxy_file": "./ansible-galaxy-requirements.yml",
      "inventory_directory": "./",
      "playbook_file": "./packer.yml",
      "type": "ansible",
      "user": "vagrant"
    }
  ]
}

