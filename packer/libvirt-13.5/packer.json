{
  "builders": [
    {
      "communicator": "ssh",
      "provider": "libvirt",
      "skip_package": true,
      "source_path": "generic/ubuntu2004",
      "teardown_method": "halt",
      "template": "./Vagrantfile.template",
      "type": "vagrant"
    }
  ],
  "post-processors": [
    {
      "inline": [
        "set -eu",
        "export _QCOW2=$(sudo bash -c \"ls -1d /var/lib/libvirt/images/output-vagrant_source*.img\")",
        "sudo virt-sysprep --operations defaults,-ssh-userdir,-ssh-hostkeys,-customize -a \"$_QCOW2\"",
        "sudo virt-sparsify --in-place \"$_QCOW2\"",
        "cd output-vagrant",
        "sudo VAGRANT_LIBVIRT_VIRT_SYSPREP_OPERATIONS=\"defaults,-ssh-userdir,-ssh-hostkeys,-customize\" vagrant package source",
        "sudo vagrant destroy --force source"
      ],
      "type": "shell-local"
    }
  ],
  "provisioners": [
    {
      "inline": [
        "set -eu",
        "sudo apt-get update",
        "sudo apt-get dist-upgrade -y",
        "sudo apt-get install -y ca-certificates curl gcc iproute2 python3 python3-dev sudo"
      ],
      "type": "shell"
    },
    {
      "galaxy_file": "./ansible-galaxy-requirements.yml",
      "inventory_directory": "./",
      "playbook_file": "./packer.yml",
      "type": "ansible",
      "user": "vagrant"
    }
  ]
}

