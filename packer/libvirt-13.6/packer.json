{
  "builders": [
    {
      "communicator": "ssh",
      "provider": "libvirt",
      "skip_package": true,
      "source_path": "generic/ubuntu2004",
      "teardown_method": "halt",
      "type": "vagrant"
    }
  ],
  "post-processors": [
    {
      "inline": [
        "set -eu",
        "sudo virt-sparsify --in-place /var/lib/libvirt/images/output-vagrant_source.img",
        "sudo virsh pool-refresh default",
        "cd output-vagrant",
        "sudo VAGRANT_LIBVIRT_VIRT_SYSPREP_OPERATIONS=\"defaults,-customize,-ssh-userdir\" vagrant package source",
        "sudo vagrant destroy --force source"
      ],
      "type": "shell-local"
    }
  ],
  "provisioners": [
    {
      "inline": [
        "set -eu",
        "sudo apt-get update",
        "sudo apt-get dist-upgrade -y",
        "sudo apt-get install -y ca-certificates curl gcc iproute2 python3 python3-dev sudo"
      ],
      "type": "shell"
    },
    {
      "galaxy_file": "./ansible-galaxy-requirements.yml",
      "inventory_directory": "./",
      "playbook_file": "./packer.yml",
      "type": "ansible",
      "user": "vagrant"
    }
  ]
}

